# workflow Ïù¥Î¶Ñ
name: ÌåùÌå° Ïï±ÌÉÄÍ≤ü iOS17 ÎπåÎìú & ÌÖåÏä§Ìä∏ v3

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR Î≤àÌò∏(Î™ÖÎ†πÏñ¥ Ìä∏Î¶¨Í±∞Ïùº ÎïåÎßå ÏûÖÎ†•)"
        required: false
        default: ""
      triggered_by_command:
        description: "PR Î™ÖÎ†πÏñ¥ Ìä∏Î¶¨Í±∞ Ïó¨Î∂Ä"
        required: false
        default: "false"

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  ios-ci:
    name: iOS Build & Test
    runs-on: macos-14

    steps:
      # ======================
      # 1Ô∏è‚É£ Checkout
      # ======================
      - name: Checkout PR branch
        if: github.event.inputs.pr_number != ''
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.inputs.pr_number }}/head

      - name: Checkout default branch
        if: github.event.inputs.pr_number == ''
        uses: actions/checkout@v4

      # ======================
      # 2Ô∏è‚É£ Cache
      # ======================
      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: DerivedData
          key: deriveddata-${{ runner.os }}-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            deriveddata-${{ runner.os }}-

      - name: Cache SwiftPM
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/org.swift.swiftpm
          key: spm-${{ runner.os }}-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            spm-${{ runner.os }}-

      # ======================
      # 3Ô∏è‚É£ Xcode ÏÑ†ÌÉù
      # ======================
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.2.app

      # ======================
      # üîí 4Ô∏è‚É£ Simulator UDID Resolve (Ï†ïÍ∑úÏãù + 1Í∞ú Í≥†Ï†ï)
      # ======================
      - name: Resolve simulator UDID
        run: |
          set -euo pipefail

          SIMULATOR_NAME="iPhone 15"
          SIMULATOR_OS="17.5"

          echo "üîç Resolving simulator: ${SIMULATOR_NAME} (iOS ${SIMULATOR_OS})"

          UDID=$(xcrun simctl list devices available | \
            grep "iOS ${SIMULATOR_OS}" -A 20 | \
            grep "${SIMULATOR_NAME}" | \
            head -n 1 | \
            sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')

          if [ -z "$UDID" ]; then
            echo "‚ùå Simulator not found"
            xcrun simctl list devices available
            exit 1
          fi

          echo "‚úÖ Using simulator UDID: $UDID"
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV

      # ======================
      # üî• 5Ô∏è‚É£ Simulator Warm-up (‚ö†Ô∏è UDIDÎßå ÏÇ¨Ïö©)
      # ======================
      - name: Warm up simulator
        run: |
          echo "üî• Warm-up simulator (UDID: $SIMULATOR_UDID)"
          xcodebuild \
            -project cicd_base.xcodeproj \
            -scheme cicd_base \
            -destination "platform=iOS Simulator,id=$SIMULATOR_UDID" \
            -showdestinations \
            > /dev/null

      # ======================
      # 6Ô∏è‚É£ Swift Macro Í≤ÄÏ¶ù Ìï¥Ï†ú
      # ======================
      - name: Disable Swift Macro fingerprint validation
        run: defaults write com.apple.dt.Xcode IDESkipMacroFingerprintValidation -bool YES

      # ======================
      # 7Ô∏è‚É£ Config.xcconfig ÏÉùÏÑ±
      # ======================
      - name: Create Config.xcconfig
        run: |
          cat <<EOF > Config.xcconfig
          KAKAO_NATIVE_APP_KEY = ${{ secrets.KAKAO_NATIVE_APP_KEY }}
          GIDClientID = ${{ secrets.GIDClientID }}
          GoogleURLScheme = ${{ secrets.GoogleURLScheme }}
          NMFClientID = ${{ secrets.NMFClientID }}
          EOF

      # ======================
      # 8Ô∏è‚É£ Build
      # ======================
      - name: Build for testing
        run: |
          set -o pipefail
          xcodebuild build-for-testing \
            -project cicd_base.xcodeproj \
            -scheme cicd_base \
            -xcconfig Config.xcconfig \
            -destination "platform=iOS Simulator,id=$SIMULATOR_UDID" \
            -derivedDataPath DerivedData \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty

      # ======================
      # 9Ô∏è‚É£ Unit Test
      # ======================
      - name: Run Unit Tests
        run: |
          set -o pipefail
          xcodebuild test-without-building \
            -project cicd_base.xcodeproj \
            -scheme cicd_base \
            -xcconfig Config.xcconfig \
            -destination "platform=iOS Simulator,id=$SIMULATOR_UDID" \
            -derivedDataPath DerivedData \
            -only-testing:RepositoryTest \
            | xcpretty

      # ======================
      # üîü UI Test
      # ======================
      - name: Run UI Tests
        run: |
          set -o pipefail
          xcodebuild test-without-building \
            -project cicd_base.xcodeproj \
            -scheme cicd_base \
            -xcconfig Config.xcconfig \
            -destination "platform=iOS Simulator,id=$SIMULATOR_UDID" \
            -derivedDataPath DerivedData \
            -only-testing:PopPangUITests \
            | xcpretty
