# workflow ì´ë¦„
name: íŒíŒ¡ ì•±íƒ€ê²Ÿ iOS17 ë¹Œë“œ & í…ŒìŠ¤íŠ¸ v3

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR ë²ˆí˜¸(ëª…ë ¹ì–´ íŠ¸ë¦¬ê±°ì¼ ë•Œë§Œ ì…ë ¥)"
        required: false
        default: ""
      triggered_by_command:
        description: "PR ëª…ë ¹ì–´ íŠ¸ë¦¬ê±° ì—¬ë¶€"
        required: false
        default: "false"

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  ios-ci:
    name: iOS Build & Test
    runs-on: macos-14

    steps:
      # PR ë²ˆí˜¸ê°€ ìˆìœ¼ë©´ í•´ë‹¹ PR ë¸Œëœì¹˜ë¡œ, ì—†ìœ¼ë©´ ê¸°ë³¸ ë¸Œëœì¹˜ë¡œ ì²´í¬ì•„ì›ƒí•©ë‹ˆë‹¤.
      - name: Checkout PR branch
        if: github.event.inputs.pr_number != ''
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.inputs.pr_number }}/head

      - name: Checkout default branch
        if: github.event.inputs.pr_number == ''
        uses: actions/checkout@v4

      # Xcode ì»´íŒŒì¼ ê²°ê³¼ë¥¼ ì¬ì‚¬ìš©í•˜ê¸° ìœ„í•´ DerivedData ìºì‹œí•©ë‹ˆë‹¤.
      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: DerivedData
          key: deriveddata-${{ runner.os }}-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            deriveddata-${{ runner.os }}-

      # Swift Package Manaer ì˜ì¡´ì„± ë‹¤ìš´ë¡œë“œ ê²°ê³¼ë¥¼ ìºì‹œí•©ë‹ˆë‹¤.
      - name: Cache SwiftPM
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/org.swift.swiftpm
          key: spm-${{ runner.os }}-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            spm-${{ runner.os }}-

      # CIì—ì„œ ì‚¬ìš©í•  Xcode ë²„ì „ì„ ê³ ì •í•©ë‹ˆë‹¤.
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.2.app
        
      # í˜„ì¬ CI í™˜ê²½ì— ì„¤ì¹˜ëœ iOS ì‹œë®¬ë ˆì´í„° ëª©ë¡ì„ ì¶œë ¥í•©ë‹ˆë‹¤.
      - name: List available iOS simulators
        run: |
          echo "ğŸ“± Available iOS Simulators"
          xcrun simctl list devices available

      # ì§€ì •í•œ ì´ë¦„ / iOS ë²„ì „ì— ë§ëŠ” ì‹œë®¬ë ˆì´í„°ì˜ UDIDë¥¼ ì°¾ì•„ í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
      - name: Resolve simulator UDID
        run: |
          set -euo pipefail

          SIMULATOR_NAME="iPhone 15"
          SIMULATOR_OS="17.0"

          echo "ğŸ” Resolving simulator: ${SIMULATOR_NAME} (iOS ${SIMULATOR_OS})"

          UDID=$(xcrun simctl list devices available | \
            grep "iOS ${SIMULATOR_OS}" -A 20 | \
            grep "^ *${SIMULATOR_NAME} (" | \
            head -n 1 | \
            sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')

          if [ -z "$UDID" ]; then
            echo "âŒ Simulator not found"
            xcrun simctl list devices available
            exit 1
          fi

          echo "âœ… Using simulator UDID: $UDID"
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV

      # ì‚´ì œ í…ŒìŠ¤íŠ¸ ì „ì— ì‹œë®¬ë ˆì´í„°ë¥¼ ë¯¸ë¦¬ ê¹¨ì›Œ ì´ˆê¸° ì§€ì—°ì„ ë°©ì§€í•©ë‹ˆë‹¤.
      - name: Warm up simulator
        run: |
          echo "ğŸ”¥ Warm-up simulator (UDID: $SIMULATOR_UDID)"
          xcodebuild \
            -project cicd_base.xcodeproj \
            -scheme cicd_base \
            -destination "id=$SIMULATOR_UDID" \
            -showdestinations \
            > /dev/null

      # CIì—ì„œ Swift Macro ì‹ ë¢° ë‹¨ê³„ í™•ì¸ì„ ê±´ë„ˆëœë‹ˆë‹¤.
      - name: Disable Swift Macro fingerprint validation
        run: defaults write com.apple.dt.Xcode IDESkipMacroFingerprintValidation -bool YES

      # CIì—ë§Œ ì‚¬ìš©í•˜ëŠ” ì„¤ì • íŒŒì¼ì„ ë§Œë“¤ê³  ì‹œí¬ë¦¿ í‚¤ë“¤ì„ ì£¼ì…í•©ë‹ˆë‹¤.
      - name: Create Config.xcconfig
        run: |
          cat <<EOF > Config.xcconfig
          KAKAO_NATIVE_APP_KEY = ${{ secrets.KAKAO_NATIVE_APP_KEY }}
          GIDClientID = ${{ secrets.GIDClientID }}
          GoogleURLScheme = ${{ secrets.GoogleURLScheme }}
          NMFClientID = ${{ secrets.NMFClientID }}
          EOF

      # ë¹Œë“œë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
      - name: Build for testing
        run: |
          set -o pipefail
          xcodebuild build-for-testing \
            -project cicd_base.xcodeproj \
            -scheme cicd_base \
            -xcconfig Config.xcconfig \
            -destination "id=$SIMULATOR_UDID" \
            -derivedDataPath DerivedData \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty

      # (ë¹Œë“œëœ ê²°ê³¼ë¥¼ ì‚¬ìš©í•´)ìœ ë‹› í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
      - name: Run Unit Tests
        run: |
          set -o pipefail
          xcodebuild test-without-building \
            -project cicd_base.xcodeproj \
            -scheme cicd_base \
            -xcconfig Config.xcconfig \
            -destination "id=$SIMULATOR_UDID" \
            -derivedDataPath DerivedData \
            -only-testing:cicd_baseUnitTests \
            | xcpretty

      # (ë¹Œë“œëœ ê²°ê³¼ë¥¼ ì‚¬ìš©í•´)UI í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
      - name: Run UI Tests
        run: |
          set -o pipefail
          xcodebuild test-without-building \
            -project cicd_base.xcodeproj \
            -scheme cicd_base \
            -xcconfig Config.xcconfig \
            -destination "id=$SIMULATOR_UDID" \
            -derivedDataPath DerivedData \
            -only-testing:cicd_baseUITests \
            | xcpretty
