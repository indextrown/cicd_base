# workflow ì´ë¦„
name: iOS7 ë¹Œë“œ & í…ŒìŠ¤íŠ¸

on:
  # main ë¸Œëœì¹˜ì— push ì´ë²¤íŠ¸ ë°œìƒì‹œ workflow trigger
  push:
    branches: [ main ]
    
  workflow_dispatch:

# workflowì˜ ì‹¤í–‰ì€ í•˜ë‚˜ ì´ìƒì˜ jobìœ¼ë¡œ êµ¬ì„± ë¨
jobs:

  # ì´ workflow ëŠ” "build" ë¼ëŠ” single job ìœ¼ë¡œ êµ¬ì„±
  build:
  
    # jobì´ ì‹¤í–‰ë  í™˜ê²½ - ìµœì‹  mac os
    runs-on: macos-14
    
    # stepì€ jobì˜ ì¼ë¶€ë¡œ ì‹¤í–‰ë  ì¼ë ¨ì˜ taskë“¤ì„ ë‚˜íƒ€ëƒ„
    steps:
    
    # uses í‚¤ì›Œë“œë¥¼ í†µí•´ Github Actionsì—ì„œ ê¸°ë³¸ìœ¼ë¡œ ì œê³µí•˜ëŠ” ì•¡ì…˜ì„ ì‚¬ìš© ê°€ëŠ¥. ì•„ë˜ ì•¡ì…˜ì€ repository ì— ì²´í¬ì•„ì›ƒí•˜ëŠ” ê²ƒ
    # 1ï¸âƒ£ ë ˆí¬ ì²´í¬ì•„ì›ƒ
    - name: Checkout
      uses: actions/checkout@v4
      
    
    # ======================================
    # 2ï¸âƒ£ SwiftPM + Xcode DerivedData ìºì‹œ
    # - SPM ì˜ì¡´ì„± ë‹¤ìš´ë¡œë“œ ê²°ê³¼
    # - swift-syntax / Macro ë¹Œë“œ ê²°ê³¼ ìºì‹œ
    # - Package.resolved ê¸°ì¤€ìœ¼ë¡œ ìºì‹œ ë¬´íš¨í™”
    # ======================================
    - name: Cache SPM & DerivedData
      uses: actions/cache@v4
      with:
        path: |
          ~/.swiftpm
          ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-
    
    # 3ï¸âƒ£ Xcode ì„ íƒ
    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode_16.2.app
      
    # 5ï¸âƒ£ Swift Macro ê²€ì¦ í•´ì œ
    - name: Disable Swift Macro fingerprint validation
      run: |
        defaults write com.apple.dt.Xcode IDESkipMacroFingerprintValidation -bool YES

    # 6ï¸âƒ£ ë¹Œë“œ & í…ŒìŠ¤íŠ¸
    - name: Start xcode build ğŸ› 
      run: |
        set -o pipefail
          xcodebuild clean build \
            -project cicd_base.xcodeproj \
            -scheme cicd_base \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.5' \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty

    - name: Start xcode Test ğŸ› 
      run: |
        set -o pipefail
          xcodebuild clean test \
            -project cicd_base.xcodeproj \
            -scheme cicd_base \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.5' \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty

     
